name: 'deps(forklift): bump "{{ .path }}" pallet'

scms:
  pallet:
    kind: github
    spec:
      owner: '{{ requiredEnv "REPO_OWNER" }}'
      repository: '{{ requiredEnv "REPO_NAME" }}'
      username: '{{ requiredEnv "GITHUB_ACTOR" }}'
      branch: main
      token: '{{ requiredEnv "GITHUB_TOKEN" }}'
      user: '{{ requiredEnv "COMMITTER_USERNAME" }}'
      email: '{{ requiredEnv "COMMITTER_EMAIL" }}'
      commitusingapi: true # this allows commits to be signed

actions:
  pull-request:
    scmid: pallet
    kind: github/pullrequest
    spec:
      title: "build(forklift): bump required Forklift pallets"
      labels:
        - dependencies
      mergemethod: squash

sources:
  current:
    name: Current version of required pallet
    kind: shell
    spec:
      environments:
        - name: PATH # needed to find the forklift binary
        - name: HOME # needed for Forklift to determine its default workspace path
      command: forklift dev pallet show-pallet-version {{ .path }}

# FIXME: add a shell condition check to ensure that the version query is valid and resolved to a
# git repo which actually is a pallet, maybe by calling `forklift inspector resolve-pallet`
# FIXME: add a condition check for whether the queried version is different from the current version

targets:
  pallet:
    # FIXME: template the current and resolved versions into the name
    name: 'require-pallet "{{ .path }}"@{{ index . "version-query" }}: {{ source "current" }}'
    kind: shell
    disablesourceinput: true
    scmid: pallet
    dependson:
      - source#current
    spec:
      environments:
        - name: PATH # needed to find the forklift binary
        - name: HOME # needed for Forklift to determine its default workspace path
      # FIXME: specify the explicit resolved version instead of the version query
      command: '{{ requiredEnv "CWD" }}/.github/forklift-require.sh pallet {{ .path }} {{ index . "version-query" }}'
